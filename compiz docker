# What this does...
# Install compiz docker container over the host desktop for wobbly windows and other special effects


# Install xfce4-desktop and docker
swupd bundle-add xfce4-desktop

# Disable graphical target and create .xinitrc
sudo systemctl set-default multi-user.target 
[[ $HOME/.xinirtc ]] && cp $HOME/.xinirtc $HOME/.xinirtc.$$.backup
echo "exec xfce4-session" > $HOME/.xinitrc
# Now reboot, login and type: startx

# Xfce4 desktop
# Turn on compositing in xfce settings manager
# Save and close

# Open up Terminal
echo -e "FROM debian \\nRUN apt update \\nRUN apt upgrade -y\\nRUN apt update -y" > /tmp/Dockerfile
sudo docker build -t debiancompiz < /tmp/Dockerfile -
xhost local:${USER}
sudo docker run -it --privileged -v /dev/shm:/dev/shm:rw --net=host -e DISPLAY=${DISPLAY} debiancompiz

# Inside the docker container Terminal
apt install compizconfig-settings-manager compiz emerald 


# Save the container at this point
sudo docker ps
sudo docker commit <CONTAINER ID>  debiancompiz  # Replace Container ID with the first ID shown after your type sudo docker ps


# Configure Compiz
ccsm
# Turn on these plugins ( if the plugin is not listed that means its probably auto-detected and installed )
# Composite, OpenGL, Window Decorations, Wobbly Windows, Grid, Move Window, Place Window, Resize Window, Shift Switcher

# Load emerald and compiz
emerald --replace &
compiz --replace &

# Emerald configuation if needed
#emerald-theme-manager &


# If things went well save the container again


# Turning off compiz...
# Open up terminal on the host side
xfwm4 --replace &
# Or log out and back in with startx


# Install nvidia drivers if you want
# From inside the container...
# Dowanload Nvidia driver https://www.nvidia.com/en-us/drivers/unix/
apt install curl kmod -y
curl -O <link to driver>
bash ./NVIDIA-Linux-<your driver here>.run --accept-license --ui=none --no-kernel-module --no-questions
nvidia-smi


# Issues
# If you turn leave off compositing on the host, opengl might not work.
# If you exit the container without first running xfwm4 --replace & on the host, your windows will have no borders.
# Try to right click on the desktop and logout and restart X with startx
#
# If you try instead to do compiz in another window manager besides Xfce chances are it wont work unless you know something I don't. :)

# Extra Stuff
# This little script will watch for compiz/emerald/xfwm4 to close and load xfwm4 automatically.  
while sleep 1; do [[ ! $(ps -A | grep compiz) && ! $(ps -A | grep xfwm4) ]] && xfwm4 --replace ; done

# Delete docker contianer - If you need to start fresh or whatever reason
# 1. sudo docker rmi debiancompiz --force

# Enable graphical target to fallback and ignore .xinitrc
# sudo systemctl set-default graphical.target
